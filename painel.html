<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Rendimento – Tratoristas</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
  <style>
    :root { --primary: #1e40af; --primary-light: #dbeafe; --success: #16a34a; --success-light: #f0fdf4; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --text: #1e293b; --muted: #64748b; --radius: 0.75rem; --radius-lg: 1rem; --shadow-sm: 0 1px 3px rgba(0,0,0,0.1); --shadow: 0 4px 12px rgba(0,0,0,0.1); --shadow-lg: 0 10px 25px rgba(0,0,0,0.12); --transition: all 0.2s ease; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', sans-serif; }
    body { background: var(--bg); color: var(--text); line-height: 1.6; }
    .container { max-width: 1360px; margin: 0 auto; padding: 1.5rem; }
    header { background: linear-gradient(135deg, var(--primary), #1e3a8a); color: white; border-radius: var(--radius-lg); padding: 1.75rem 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-lg); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    header h1 { font-weight: 800; font-size: 1.9rem; letter-spacing: 0.5px; }
    .header-info { text-align: right; font-size: 0.9rem; display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; }
    .header-info strong { color: #fbbf24; }
    .btn-logout { background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.8rem; cursor: pointer; }
    .btn-logout:hover { background: #b91c1c; }

    /* SELECT COM ROLAGEM */
    #fazenda-select {
      max-height: 200px;
      overflow-y: auto;
      padding: 0.4rem;
      border-radius: 0.5rem;
      border: 1px solid #fff;
      background: #1e40af;
      color: white;
      font-size: 0.9rem;
      width: 180px;
    }
    #fazenda-select::-webkit-scrollbar { width: 8px; }
    #fazenda-select::-webkit-scrollbar-track { background: #1e3a8a; border-radius: 4px; }
    #fazenda-select::-webkit-scrollbar-thumb { background: #60a5fa; border-radius: 4px; }
    #fazenda-select::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.75rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); }
    .grid { display: grid; gap: 1rem; }
    .g-6 { grid-template-columns: repeat(6, 1fr); }
    .g-3 { grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 1100px) { .g-6 { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 640px) { .g-6, .g-3 { grid-template-columns: 1fr; } }
    label { font-weight: 600; color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.25rem; }
    .multi { color: var(--muted); font-weight: 500; font-size: 0.8rem; }
    select, input { width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); background: #fff; font: inherit; transition: var(--transition); }
    select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15); }
    .choices__inner { border: 1.5px solid var(--border) !important; border-radius: var(--radius) !important; min-height: 44px !important; padding: 0.375rem 0.5rem !important; }
    .choices.is-focused .choices__inner { border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15) !important; }
    .choices__list--multiple .choices__item { background: var(--success); border-color: var(--success); color: white; font-weight: 600; border-radius: 999px; font-size: 0.8rem; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 999px; font-weight: 700; font-size: 0.95rem; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: var(--transition); box-shadow: var(--shadow-sm); text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: var(--success); color: white; }
    .btn-primary:hover { background: #15803d; transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-secondary { background: #e2e8f0; color: var(--text); }
    .btn-secondary:hover { background: #cbd5e1; }
    .bar { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem; justify-content: center; align-items: center; }
    .pill { background: var(--success-light); color: #166534; padding: 0.5rem 1rem; border-radius: 999px; font-weight: 600; font-size: 0.8rem; box-shadow: var(--shadow-sm); }
    .table-wrapper { overflow-x: auto; border-radius: var(--radius-lg); box-shadow: var(--shadow); margin-top: 1rem; }
    table { width: 100%; min-width: 1100px; border-collapse: collapse; background: white; }
    thead th { background: var(--primary); color: white; font-weight: 700; padding: 0.875rem 0.75rem; text-align: center; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
    tbody td { padding: 0.875rem 0.75rem; text-align: center; border-top: 1px solid var(--border); font-weight: 500; }
    tbody tr:nth-child(even) td { background: #fdfdfd; }
    tbody tr:hover td { background: var(--primary-light); }
    .total { background: var(--success-light) !important; font-weight: 800; color: #166534; }
    .operator { text-align: left !important; font-weight: 600; color: var(--text); }
    .empty { padding: 3rem; text-align: center; color: var(--muted); font-style: italic; }

    /* RANKING ESTILIZADO */
    .ranking { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
    .rank-card { background: white; border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; box-shadow: var(--shadow); text-align: left; position: relative; overflow: hidden; }
    .rank-title { font-weight: 700; color: var(--primary); margin-bottom: 1rem; font-size: 0.95rem; text-transform: uppercase; text-align: center; }
    .rank-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: #f8fafc; border-radius: var(--radius); border-left: 4px solid transparent; transition: all 0.2s ease; }
    .rank-item:hover { background: #eef2ff; border-left-color: var(--primary); transform: translateX(4px); }
    .rank-pos { font-weight: 800; font-size: 1.1rem; width: 2.2rem; text-align: center; }
    .rank-pos.gold { color: #fbbf24; }
    .rank-pos.silver { color: #94a3b8; }
    .rank-pos.bronze { color: #d97706; }
    .rank-name { flex: 1; font-weight: 600; color: var(--text); font-size: 0.95rem; }
    .rank-value { font-weight: 700; color: var(--success); font-size: 0.9rem; }

    .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 999px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.75rem; transform: translateX(120%); opacity: 0; transition: all 0.4s ease; z-index: 1000; font-weight: 600; }
    .toast.show { transform: translateX(0); opacity: 1; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Painel de Rendimento – Tratoristas</h1>
        <div class="week">Semana: <span id="semana-label"></span></div>
      </div>
      <div class="header-info">
        Gerente: <strong id="gerente-nome"></strong><br>
        Fazenda: 
        <select id="fazenda-select" size="1"></select>
        <button class="btn-logout" id="btn-logout">Sair</button>
      </div>
    </header>

    <section class="card">
      <div class="grid g-6">
        <div><label>Frota</label><select id="frota"></select></div>
        <div><label>Operador <span class="multi">(multi)</span></label><select id="operador" multiple></select></div>
        <div><label>Operações</label><select id="operacao"><option>Inseticida</option><option>Fungicida</option><option>Adubação</option><option>Pinta Preta</option></select></div>
        <div><label>Turno</label><select id="turno"><option>Dia</option><option>Noite</option></select></div>
        <div><label>Unidade</label><select id="unidade"><option>BB</option><option>Há</option><option>KG</option></select></div>
      </div>

      <div class="grid g-3" style="margin-top:1.5rem">
        <div><label>Dia da Semana <span class="multi">(multi)</span></label><select id="dias" multiple><option value="seg">Segunda</option><option value="ter">Terça</option><option value="qua">Quarta</option><option value="qui">Quinta</option><option value="sex">Sexta</option><option value="sab">Sábado</option><option value="dom">Domingo</option></select></div>
        <div><label>Rend. Programado</label><input id="prog" type="number" step="0.1" placeholder="0.0"></div>
        <div><label>Rend. Real</label><input id="real" type="number" step="0.1" placeholder="0.0"></div>
      </div>

      <div class="bar">
        <button class="btn btn-primary" id="btn-salvar">Salvar Lançamento</button>
        <div class="pill" id="badge-semana"></div>
      </div>
    </section>

    <section class="card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th rowspan="2">OPERADOR</th>
              <th colspan="2">SEG</th><th colspan="2">TER</th><th colspan="2">QUA</th>
              <th colspan="2">QUI</th><th colspan="2">SEX</th><th colspan="2">SÁB</th>
              <th colspan="2">DOM</th><th colspan="2">TOTAL</th>
            </tr>
            <tr>
              <th>P</th><th>R</th><th>P</th><th>R</th><th>P</th><th>R</th>
              <th>P</th><th>R</th><th>P</th><th>R</th><th>P</th><th>R</th>
              <th>P</th><th>R</th><th>P</th><th>R</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="bar" style="margin-top:1.5rem">
        <button class="btn btn-secondary" id="btn-limpar">Limpar Tudo</button>
      </div>

      <div class="ranking">
        <div class="rank-card">
          <div class="rank-title">MAIS BOMBAS (R)</div>
          <div class="rank-list">
            <div class="rank-item">
              <span class="rank-pos gold">1º</span>
              <span class="rank-name" id="rank-bb-name-1">—</span>
              <span class="rank-value" id="rank-bb-val-1">— BB</span>
            </div>
            <div class="rank-item">
              <span class="rank-pos silver">2º</span>
              <span class="rank-name" id="rank-bb-name-2">—</span>
              <span class="rank-value" id="rank-bb-val-2">— BB</span>
            </div>
            <div class="rank-item">
              <span class="rank-pos bronze">3º</span>
              <span class="rank-name" id="rank-bb-name-3">—</span>
              <span class="rank-value" id="rank-bb-val-3">— BB</span>
            </div>
          </div>
        </div>

        <div class="rank-card">
          <div class="rank-title">MAIS HECTARES (R)</div>
          <div class="rank-list">
            <div class="rank-item">
              <span class="rank-pos gold">1º</span>
              <span class="rank-name" id="rank-ha-name-1">—</span>
              <span class="rank-value" id="rank-ha-val-1">— Há</span>
            </div>
            <div class="rank-item">
              <span class="rank-pos silver">2º</span>
              <span class="rank-name" id="rank-ha-name-2">—</span>
              <span class="rank-value" id="rank-ha-val-2">— Há</span>
            </div>
            <div class="rank-item">
              <span class="rank-pos bronze">3º</span>
              <span class="rank-name" id="rank-ha-name-3">—</span>
              <span class="rank-value" id="rank-ha-val-3">— Há</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"><span id="toast-msg">Lançamento salvo!</span></div>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    const toast = (msg, time = 3000) => {
      $('toast-msg').textContent = msg;
      $('toast').classList.add('show');
      setTimeout(() => $('toast').classList.remove('show'), time);
    };

    const usuario = localStorage.getItem('usuario_logado');
    const fazendasLiberadas = JSON.parse(localStorage.getItem('fazendas_liberadas') || '[]');
    const isAdmin = localStorage.getItem('is_admin') === 'true';

    if (!usuario) window.location.href = 'login.html';

    $('gerente-nome').textContent = usuario.toUpperCase();

    const fazendaSelect = $('fazenda-select');
    let fazendaAtual = localStorage.getItem('fazenda_atual') || "";

    let fazendasDisponiveis = isAdmin 
      ? JSON.parse(localStorage.getItem('fazendas') || '[]')
      : fazendasLiberadas;

    if (fazendasDisponiveis.length === 0) {
      fazendaSelect.innerHTML = '<option value="">Nenhuma fazenda</option>';
      fazendaSelect.disabled = true;
    } else {
      fazendaSelect.innerHTML = '';
      fazendasDisponiveis.forEach(f => {
        const opt = new Option(f, f, false, f === fazendaAtual);
        fazendaSelect.add(opt);
      });
      fazendaSelect.disabled = false;
      if (!fazendasDisponiveis.includes(fazendaAtual) && fazendasDisponiveis.length > 0) {
        fazendaAtual = fazendasDisponiveis[0];
        localStorage.setItem('fazenda_atual', fazendaAtual);
      }
    }

    fazendaSelect.addEventListener('change', () => {
      fazendaAtual = fazendaSelect.value;
      localStorage.setItem('fazenda_atual', fazendaAtual);
      updateOperadores();
      render();
    });

    const getFrotas = () => JSON.parse(localStorage.getItem('frotas') || '[]');
    const getTratoristas = (fazenda, frota) => {
      const data = JSON.parse(localStorage.getItem('tratoristas') || '{}');
      return data[fazenda]?.[frota] || [];
    };

    const getSemana = () => {
      const d = new Date();
      const wd = d.getDay();
      const mon = new Date(d); mon.setDate(d.getDate() - (wd === 0 ? 6 : wd - 1));
      const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
      const fmt = x => x.toLocaleDateString('pt-BR');
      const key = `${mon.getFullYear()}${String(mon.getMonth()+1).padStart(2,'0')}${String(mon.getDate()).padStart(2,'0')}_${sun.getFullYear()}${String(sun.getMonth()+1).padStart(2,'0')}${String(sun.getDate()).padStart(2,'0')}`;
      return { label: `${fmt(mon)} a ${fmt(sun)}`, key };
    };
    const { label: SEM_LABEL, key: SEM_KEY } = getSemana();
    $('semana-label').textContent = SEM_LABEL;
    $('badge-semana').textContent = SEM_LABEL;

    const LS_KEY = `rend_${fazendaAtual}_${SEM_KEY}`;
    const db = {
      get: () => JSON.parse(localStorage.getItem(LS_KEY) || "{}"),
      set: (data) => localStorage.setItem(LS_KEY, JSON.stringify(data)),
      clear: () => localStorage.removeItem(LS_KEY)
    };

    if (Object.keys(db.get()).length === 0 && fazendaAtual === "SLP") {
      db.set({
        "JOÃO": { "727": { "Dia": { "BB": { "seg": { p: 120, r: 118.5 }, "ter": { p: 120, r: 122 }, "qua": { p: 120, r: 115 } } } } },
        "PEDRO": { "727": { "Dia": { "BB": { "seg": { p: 110, r: 108 }, "ter": { p: 110, r: 112 } } } } },
        "MARIA": { "728": { "Dia": { "BB": { "seg": { p: 130, r: 132 } } } } }
      });
    }

    const fill = (id, arr) => {
      const s = $(id);
      s.innerHTML = "";
      arr.forEach(v => s.add(new Option(v, v)));
    };
    fill("frota", getFrotas());

    const choicesOper = new Choices("#operador", { removeItemButton: true, shouldSort: false, placeholderValue: "Selecione..." });
    const choicesDias = new Choices("#dias", { removeItemButton: true, shouldSort: false, placeholderValue: "Dias..." });

    const updateOperadores = () => {
      const frota = $('frota').value;
      const ops = getTratoristas(fazendaAtual, frota);
      choicesOper.clearChoices();
      choicesOper.setChoices(ops.map(o => ({ value: o, label: o })), 'value', 'label', true);
    };
    $('frota').addEventListener('change', updateOperadores);

    const calcularRanking = () => {
      const data = db.get();
      const frota = $('frota').value;
      const turno = $('turno').value;

      let totalBB = {}, totalHa = {};

      Object.keys(data).forEach(op => {
        const frotaData = data[op][frota]?.[turno];
        if (!frotaData) return;

        Object.keys(frotaData).forEach(unidade => {
          const dias = frotaData[unidade];
          let somaR = 0;
          Object.values(dias).forEach(d => somaR += Number(d.r) || 0);

          if (unidade === "BB") totalBB[op] = (totalBB[op] || 0) + somaR;
          if (unidade === "Há") totalHa[op] = (totalHa[op] || 0) + somaR;
        });
      });

      const format = (obj, nameIds, valIds, unit) => {
        const sorted = Object.entries(obj).sort((a,b) => b[1] - a[1]).slice(0, 3);
        for (let i = 0; i < 3; i++) {
          if (sorted[i]) {
            $(nameIds[i]).textContent = sorted[i][0];
            $(valIds[i]).textContent = `${sorted[i][1].toFixed(1)} ${unit}`;
          } else {
            $(nameIds[i]).textContent = "—";
            $(valIds[i]).textContent = `— ${unit}`;
          }
        }
      };

      format(totalBB, 
        ['rank-bb-name-1', 'rank-bb-name-2', 'rank-bb-name-3'],
        ['rank-bb-val-1', 'rank-bb-val-2', 'rank-bb-val-3'],
        'BB'
      );
      format(totalHa, 
        ['rank-ha-name-1', 'rank-ha-name-2', 'rank-ha-name-3'],
        ['rank-ha-val-1', 'rank-ha-val-2', 'rank-ha-val-3'],
        'Há'
      );
    };

    const render = () => {
      const data = db.get();
      const frota = $('frota').value;
      const turno = $('turno').value;
      const unidade = $('unidade').value;

      const tbody = $('tbody');
      tbody.innerHTML = "";

      const ops = Object.keys(data).filter(op => data[op]?.[frota]?.[turno]?.[unidade]).sort();
      if (!ops.length) {
        tbody.innerHTML = `<tr><td colspan="17" class="empty">Nenhum dado para o filtro atual.</td></tr>`;
        calcularRanking();
        return;
      }

      ops.forEach(op => {
        const bloc = data[op][frota][turno][unidade];
        let totalP = 0, totalR = 0;
        const cells = ["seg","ter","qua","qui","sex","sab","dom"].map(d => {
          const v = bloc[d] || { p: 0, r: 0 };
          const p = Number(v.p) || 0;
          const r = Number(v.r) || 0;
          totalP += p; totalR += r;
          return `<td>${p.toFixed(1)}</td><td>${r.toFixed(1)}</td>`;
        }).join("");

        tbody.innerHTML += `
          <tr>
            <td class="operator">${op}</td>
            ${cells}
            <td class="total">${totalP.toFixed(1)}</td>
            <td class="total">${totalR.toFixed(1)}</td>
          </tr>
        `;
      });

      calcularRanking();
    };

    const salvar = () => {
      const ops = choicesOper.getValue(true);
      const dias = choicesDias.getValue(true);
      const progRaw = $('prog').value.trim();
      const realRaw = $('real').value.trim();
      const hasP = progRaw !== "";
      const hasR = realRaw !== "";
      const p = hasP ? parseFloat(progRaw) : null;
      const r = hasR ? parseFloat(realRaw) : null;

      if (!ops.length) return toast("Selecione ao menos um operador.", 4000);
      if (!dias.length) return toast("Selecione ao menos um dia.", 4000);
      if (hasP && Number.isNaN(p)) return toast("Programado inválido.", 4000);
      if (hasR && Number.isNaN(r)) return toast("Real inválido.", 4000);

      const data = db.get();
      const frota = $('frota').value;
      const turno = $('turno').value;
      const unidade = $('unidade').value;

      ops.forEach(op => {
        data[op] ??= {};
        data[op][frota] ??= {};
        data[op][frota][turno] ??= {};
        data[op][frota][turno][unidade] ??= {};

        dias.forEach(d => {
          const prev = data[op][frota][turno][unidade][d] || { p: 0, r: 0 };
          data[op][frota][turno][unidade][d] = {
            p: hasP ? p : prev.p,
            r: hasR ? r : prev.r
          };
        });
      });

      db.set(data);
      render();
      $('prog').value = '';
      $('real').value = '';
      toast("Lançamento salvo com sucesso!");
    };

    $('btn-logout').onclick = () => {
      localStorage.removeItem('usuario_logado');
      localStorage.removeItem('fazendas_liberadas');
      localStorage.removeItem('is_admin');
      localStorage.removeItem('fazenda_atual');
      window.location.href = 'login.html';
    };

    $('btn-limpar').onclick = () => {
      if (confirm("Apagar TODOS os dados da semana?")) {
        db.clear();
        render();
        toast("Dados apagados.");
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      updateOperadores();
      render();
    });

    $('btn-salvar').onclick = salvar;
  </script>
</body>
</html>